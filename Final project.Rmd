---
title: "Final project"
author: "Matt Kalin"
date: "5/18/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

## Importing the data
The data was downloaded from https://www.kaggle.com/divyansh22/us-border-crossing-data?select=Border_Crossing_Entry_Data.csv.  If you have a Kaggle account (they are free and only take a minute to set up), you can download the data as a csv by clicking a button at the top right of the page. I then read it into R by reading the csv file. 
```{r import}
bd = read.csv("/Users/malexk999/Desktop/University of Maryland/Junior year/Spring/CMSC 320/Projects/Final/Border_Crossing_Entry_Data.csv")

```

## Data tidying
I examined the dates by extracting their month, year, and day of the week.  
```{r tidy}
library(dplyr)
border.data = bd %>% 
  mutate(Date = as.Date(Date, format = "%m/%d/%Y"), 
         Weekday = weekdays(Date), 
         Month = months(Date),
         Year = as.numeric(format(Date, "%Y")), 
         Measure = Measure %>% 
           factor() %>% 
           make.names())
```

## Modeling
We want to create a model that predicts the number of people who cross the border
```{r linmod}
m = lm(Value ~ Port.Name + Month + Year + Measure, data = border.data)
m2 = lm(Value ~ State + Month + Year + Measure, data = border.data)
# day of week found to be insignificant 
```

## Analysis of the model
```{r plots, include=TRUE}
PlotCoeffs = function(var.name, model = m, data = border.data, sort.vars = FALSE){
  coeff.names = paste0(var.name, unique(rev(data[, var.name]))) # reversed because the oldest entries are at the bottom of the dataset 
  if(sort.vars){
    coeff.names = sort(coeff.names)
  }
  all.coeffs = model$coefficients
  var.coeffs = model$coefficients[coeff.names] %>% na.omit()
  baseline = setdiff(coeff.names, names(var.coeffs))
  # base.value = all.coeffs["(Intercept)"] - all.coeffs["Year"] * mean(data$Year)
  var.coeffs[baseline] = 0
  var.coeffs = var.coeffs[coeff.names] # this is to get them in the proper order
  # var.coeffs = var.coeffs + base.value
  level.names = substr(coeff.names, nchar(var.name) + 1, nchar(coeff.names))
  coeff.table = data.frame("Name" = level.names, "Coeff" = var.coeffs)
  # return(coeff.table)
  #coeff.table %>% 
  #  ggplot(aes(x = Name, y = Coeff)) + 
  #  geom_bar(stat = "identity") + 
  #  coord_flip() 
  # do "April" not "MonthApril" 
  # incorporate intercept to get rid of negatives
}
categ.vars = border.data %>% 
  select(Port.Name, Month, Measure) %>%
  names() # all categorical variables
# for (var.name in categ.vars) {
#   PlotCoeffs(var.name, m, border.data)
# }

ports <- PlotCoeffs("Port.Name", m, border.data)
ports %>% 
    ggplot(aes(x = Name, y = Coeff)) + 
    geom_bar(stat = "identity") + 
    labs(title = "Ports") +
    coord_flip() 

months <- PlotCoeffs("Month", m, border.data)
months %>% 
    ggplot(aes(x = Name, y = Coeff)) + 
    geom_bar(stat = "identity") + 
    labs(title = "Months") +
    coord_flip() 

trans <- PlotCoeffs("Measure", m, border.data)
trans %>% 
    ggplot(aes(x = Name, y = Coeff)) + 
    geom_bar(stat = "identity") + 
    labs(title = "Transportation Type") +
    coord_flip() 

states <- PlotCoeffs("State", m2, border.data, sort.vars = TRUE)
states %>% 
    ggplot(aes(x = Name, y = Coeff)) + 
    geom_bar(stat = "identity") + 
    labs(title = "States") +
    coord_flip() 
```

```{r state_plots}
border.data.ca <- border.data %>%
  filter(State == "CA")

border.data.tx <- border.data %>%
  filter(State == "TX")

border.data.mi <- border.data %>%
  filter(State == "MI")

ca <- PlotCoeffs("Port.Name", m, border.data.ca)
ca %>% 
    ggplot(aes(x = Name, y = Coeff)) + 
    geom_bar(stat = "identity") + 
    labs(title = "California Ports") +
    coord_flip() 

tx <- PlotCoeffs("Port.Name", m, border.data.tx)
tx %>% 
    ggplot(aes(x = Name, y = Coeff)) + 
    geom_bar(stat = "identity") + 
    labs(title = "Texas Ports") +
    coord_flip() 

mi <- PlotCoeffs("Port.Name", m, border.data.mi)
mi %>% 
    ggplot(aes(x = Name, y = Coeff)) + 
    geom_bar(stat = "identity") + 
    labs(title = "Michigan Ports") +
    coord_flip() 
```
